<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Josun Hotel 챗봇</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <!-- Pretendard 폰트 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <style>
    * { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
    @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }
    .skeleton-line { animation: pulse 1.5s ease-in-out infinite; }

    /* 마크다운 콘텐츠 스타일 */
    .markdown-content {
      word-break: keep-all;
      overflow-wrap: break-word;
      line-height: 1.7;
    }
    .markdown-content p { margin: 0 0 12px 0; }
    .markdown-content p:last-child { margin-bottom: 0; }
    .markdown-content a {
      color: #2563eb;
      text-decoration: underline;
      word-break: break-all;
    }
    .markdown-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .markdown-content pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
    }
    .markdown-content pre code {
      background: transparent;
      padding: 0;
      color: inherit;
    }
    .markdown-content ul, .markdown-content ol {
      padding-left: 0;
      margin: 8px 0;
      list-style-position: inside;
    }
    .markdown-content li {
      margin: 4px 0;
    }
  </style>
</head>
<body class="bg-white h-screen flex flex-col text-base">
  <div id="app" class="h-full flex flex-col"></div>

  <script>
    // ========== 호텔 데이터 ==========
    const HOTELS = [
      { id: 'josun_palace', name: '조선 팰리스' },
      { id: 'grand_josun_busan', name: '그랜드 조선 부산' },
      { id: 'grand_josun_jeju', name: '그랜드 조선 제주' },
      { id: 'lescape', name: '레스케이프' },
      { id: 'gravity_pangyo', name: '그래비티 판교' }
    ];

    // ========== 상태 ==========
    let state = {
      currentHotel: null,
      messages: [],
      isSending: false,
      showHotelDropdown: false
    };

    // 타이머 관련
    let thinkingTimer = null;
    let thinkingStartTime = null;

    // ========== API 설정 ==========
    const API_BASE_URL = 'http://localhost:8000';

    async function callAPI(hotelId, message, history = []) {
      const response = await fetch(`${API_BASE_URL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hotelId, message, history })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }

    // 대화 히스토리 추출 (최근 6개 메시지 = 3턴)
    function getConversationHistory() {
      const relevantMessages = state.messages
        .filter(m => m.role === 'user' || (m.role === 'assistant' && m.status === 'done'))
        .slice(-6)  // 최근 6개
        .map(m => ({
          role: m.role,
          content: m.content
        }));
      return relevantMessages;
    }

    // ========== 렌더링 ==========
    function render() {
      const app = document.getElementById('app');
      const h = state.currentHotel;

      app.innerHTML = `
        <header class="border-b px-5 py-4 flex items-center justify-between flex-shrink-0">
          <span class="text-lg font-semibold text-gray-900">Josun Hotel 챗봇</span>
          <div class="flex items-center gap-4">
            <div class="relative">
              <button data-action="toggle-dropdown" class="text-base px-4 py-2 rounded-full border ${h ? 'border-gray-300 text-gray-700' : 'border-gray-400 text-gray-500'} hover:bg-gray-50 transition">
                ${h ? h.name : '호텔 선택'}
              </button>
              <div id="dropdown" class="${state.showHotelDropdown ? '' : 'hidden'} absolute right-0 mt-2 w-52 bg-white border rounded-xl shadow-lg py-2 z-10">
                ${HOTELS.map(hotel => `
                  <button data-action="select-hotel" data-hotel-id="${hotel.id}" class="w-full text-left px-5 py-3 text-base ${h && h.id === hotel.id ? 'bg-gray-100 text-gray-900 font-medium' : 'text-gray-700'} hover:bg-gray-50">
                    ${hotel.name}
                  </button>
                `).join('')}
              </div>
            </div>
            <button data-action="new-chat" class="text-base text-gray-500 hover:text-gray-700">새 대화</button>
          </div>
        </header>

        <div id="message-list" class="flex-1 overflow-y-auto">
          <div class="max-w-3xl mx-auto px-5 py-8">
            ${state.messages.length === 0 ? renderEmptyState(h) : renderMessages()}
          </div>
        </div>

        <div class="border-t p-5 flex-shrink-0">
          <div class="max-w-3xl mx-auto">
            <div class="flex gap-4">
              <textarea
                id="message-input"
                class="flex-1 border rounded-xl px-5 py-4 resize-none focus:outline-none focus:border-gray-400 text-base ${!h ? 'bg-gray-100 cursor-not-allowed' : ''}"
                rows="1"
                placeholder="${!h ? '호텔을 먼저 선택해 주세요' : '메시지를 입력하세요... (Enter 전송, Shift+Enter 줄바꿈)'}"
                ${state.isSending || !h ? 'disabled' : ''}
              ></textarea>
              <button
                data-action="send"
                class="px-6 py-3 text-base rounded-xl transition ${state.isSending || !h ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-gray-900 text-white hover:bg-gray-800'}"
                ${state.isSending || !h ? 'disabled' : ''}
              >전송</button>
            </div>
            <p class="text-sm text-gray-400 mt-3 text-center">AI 챗봇은 간혹 사실과 다른 내용이 포함될 수 있습니다.</p>
          </div>
        </div>
      `;

      // 입력창 포커스 및 키보드 이벤트
      const input = document.getElementById('message-input');
      if (input) {
        input.focus();
        input.onkeydown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
          }
        };
      }

      scrollToBottom();
    }

    function renderEmptyState(h) {
      return `
        <div class="h-full flex items-center justify-center min-h-[60vh]">
          <div class="text-center">
            <p class="text-2xl font-semibold text-gray-800 mb-8">${h ? h.name + '에 대해 질문해 주세요' : '호텔을 선택 후 질문해 주세요'}</p>
            <div class="flex flex-wrap justify-center gap-3 mb-10">
              ${HOTELS.map(hotel => `
                <button data-action="select-hotel" data-hotel-id="${hotel.id}" class="text-base px-4 py-2 rounded-full border ${h && h.id === hotel.id ? 'border-gray-900 text-gray-900 bg-gray-100 font-medium' : 'border-gray-300 text-gray-600'} hover:border-gray-400 transition">
                  ${hotel.name}
                </button>
              `).join('')}
            </div>
            <div class="space-y-3 text-base text-gray-400">
              <p data-action="example" data-text="체크인 시간이 어떻게 되나요?" class="cursor-pointer hover:text-gray-600">체크인 시간이 어떻게 되나요?</p>
              <p data-action="example" data-text="주차장 이용 가능한가요?" class="cursor-pointer hover:text-gray-600">주차장 이용 가능한가요?</p>
              <p data-action="example" data-text="조식 운영 시간 알려주세요" class="cursor-pointer hover:text-gray-600">조식 운영 시간 알려주세요</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderMessages() {
      return `<div class="space-y-8">${state.messages.map(renderMessage).join('')}</div>`;
    }

    function renderMessage(msg) {
      if (msg.role === 'system') {
        return `<div class="text-center text-sm text-gray-400 py-3">${msg.content}</div>`;
      }

      const isUser = msg.role === 'user';

      if (msg.status === 'thinking') {
        const elapsed = thinkingStartTime ? Math.floor((Date.now() - thinkingStartTime) / 1000) : 0;
        return `
          <div class="flex justify-start">
            <div class="max-w-[85%]">
              <p class="text-base text-gray-500 mb-3">생각중(<span id="thinking-timer">${String(elapsed).padStart(2, '0')}</span>s)...</p>
              <div class="space-y-3">
                <div class="skeleton-line h-5 bg-gray-200 rounded w-72"></div>
                <div class="skeleton-line h-5 bg-gray-200 rounded w-56"></div>
              </div>
            </div>
          </div>
        `;
      }

      const content = isUser ? escapeHtml(msg.content) : renderMarkdown(msg.content);

      // 봇 응답에 타임스탬프 표시
      const timeInfo = (!isUser && msg.timestamp && msg.elapsedTime !== undefined)
        ? `<p class="text-sm text-gray-400 mt-3">${msg.timestamp} (${String(msg.elapsedTime).padStart(2, '0')}s)</p>`
        : '';

      // 명확화 옵션 버튼 렌더링
      const clarificationButtons = (!isUser && msg.needsClarification && msg.clarificationOptions && msg.clarificationOptions.length > 0)
        ? `<div class="flex flex-wrap gap-2 mt-4">
            ${msg.clarificationOptions.map(opt => `
              <button data-action="clarification-option" data-option="${escapeHtml(opt)}"
                class="px-4 py-2 text-sm rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-gray-400 transition">
                ${escapeHtml(opt)}
              </button>
            `).join('')}
          </div>`
        : '';

      return `
        <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
          <div class="max-w-[85%] ${isUser ? 'bg-gray-100 rounded-2xl rounded-br-sm px-5 py-4' : ''}">
            <div class="${isUser ? 'text-base' : 'text-base markdown-content'}">${content}</div>
            ${clarificationButtons}
            ${timeInfo}
          </div>
        </div>
      `;
    }

    function renderMarkdown(text) {
      if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
        const html = marked.parse(text);
        return DOMPurify.sanitize(html, { ADD_ATTR: ['target'] }).replace(/<a /g, '<a target="_blank" ');
      }
      return escapeHtml(text);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function scrollToBottom() {
      const list = document.getElementById('message-list');
      if (list) setTimeout(() => list.scrollTop = list.scrollHeight, 50);
    }

    // ========== 타이머 함수 ==========
    function startThinkingTimer() {
      thinkingStartTime = Date.now();
      thinkingTimer = setInterval(() => {
        const timerEl = document.getElementById('thinking-timer');
        if (timerEl) {
          const elapsed = Math.floor((Date.now() - thinkingStartTime) / 1000);
          timerEl.textContent = String(elapsed).padStart(2, '0');
        }
      }, 1000);
    }

    function stopThinkingTimer() {
      if (thinkingTimer) {
        clearInterval(thinkingTimer);
        thinkingTimer = null;
      }
      const elapsed = thinkingStartTime ? Math.floor((Date.now() - thinkingStartTime) / 1000) : 0;
      thinkingStartTime = null;
      return elapsed;
    }

    function formatTimestamp(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const h = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      const s = String(date.getSeconds()).padStart(2, '0');
      return `${y}-${m}-${d} ${h}:${min}:${s}`;
    }

    // ========== 이벤트 핸들러 ==========
    async function handleSend() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message || state.isSending || !state.currentHotel) return;

      // 사용자 메시지 추가
      state.messages.push({ id: Date.now(), role: 'user', content: message, status: 'done' });

      // 생각중 메시지 추가
      const thinkingId = Date.now() + 1;
      state.messages.push({ id: thinkingId, role: 'assistant', content: '', status: 'thinking' });

      state.isSending = true;
      render();

      // 타이머 시작
      startThinkingTimer();

      // 대화 히스토리 추출 (현재 메시지 제외)
      const history = getConversationHistory();

      try {
        const response = await callAPI(state.currentHotel.id, message, history);
        const elapsedTime = stopThinkingTimer();
        const timestamp = formatTimestamp(new Date());

        const idx = state.messages.findIndex(m => m.id === thinkingId);
        if (idx !== -1) {
          state.messages[idx] = {
            ...state.messages[idx],
            content: response.answer,
            status: 'done',
            timestamp: timestamp,
            elapsedTime: elapsedTime,
            // 명확화 관련 필드
            needsClarification: response.needsClarification || false,
            clarificationOptions: response.clarificationOptions || []
          };
        }
      } catch (error) {
        console.error('API 에러:', error);
        const elapsedTime = stopThinkingTimer();
        const timestamp = formatTimestamp(new Date());

        const idx = state.messages.findIndex(m => m.id === thinkingId);
        if (idx !== -1) {
          state.messages[idx] = {
            ...state.messages[idx],
            content: '요청에 실패했어요. 다시 시도해 주세요.',
            status: 'error',
            timestamp: timestamp,
            elapsedTime: elapsedTime
          };
        }
      }

      state.isSending = false;
      render();
    }

    // ========== 이벤트 위임 (한 번만 등록) ==========
    document.getElementById('app').addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) {
        // 드롭다운 외부 클릭 시 닫기
        if (state.showHotelDropdown && !e.target.closest('#dropdown')) {
          state.showHotelDropdown = false;
          render();
        }
        return;
      }

      const action = target.dataset.action;

      switch (action) {
        case 'toggle-dropdown':
          state.showHotelDropdown = !state.showHotelDropdown;
          render();
          break;

        case 'select-hotel':
          const hotelId = target.dataset.hotelId;
          const newHotel = HOTELS.find(h => h.id === hotelId);
          if (newHotel) {
            if (state.currentHotel && state.currentHotel.id !== hotelId && state.messages.length > 0) {
              state.messages.push({ id: Date.now(), role: 'system', content: `${newHotel.name}(으)로 변경됨` });
            }
            state.currentHotel = newHotel;
            state.showHotelDropdown = false;
            render();
          }
          break;

        case 'new-chat':
          state.messages = [];
          render();
          break;

        case 'send':
          handleSend();
          break;

        case 'example':
          if (state.currentHotel) {
            const input = document.getElementById('message-input');
            if (input) {
              input.value = target.dataset.text;
              input.focus();
            }
          } else {
            alert('호텔을 선택 후 이용해 주세요');
          }
          break;

        case 'clarification-option':
          // 명확화 옵션 선택 시 해당 옵션으로 새 질문
          const selectedOption = target.dataset.option;
          if (selectedOption && state.currentHotel && !state.isSending) {
            // 입력창에 선택한 옵션 넣고 전송
            const input = document.getElementById('message-input');
            if (input) {
              input.value = selectedOption;
              handleSend();
            }
          }
          break;
      }
    });

    // ========== 초기화 ==========
    render();
  </script>
</body>
</html>
