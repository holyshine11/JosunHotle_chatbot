# ============================================================
# GitHub Actions: main ë¸Œëœì¹˜ push â†’ NCP ì„œë²„ ìë™ ë°°í¬
# ë°©ì‹: SSH ì ‘ì† â†’ deploy.sh ì‹¤í–‰ (ì„œë²„ì—ì„œ ë¹Œë“œ)
# ============================================================

name: Deploy to NCP

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'doc/**'
      - 'tests/**'
      - '.claude/**'

# ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USER }}
          key: ${{ secrets.NCP_SSH_KEY }}
          port: ${{ secrets.NCP_SSH_PORT || 22 }}
          timeout: 600s
          script: |
            echo "=== ë°°í¬ ì‹œì‘: $(date) ==="
            /opt/josun_chatbot/deploy/deploy.sh
            echo "=== ë°°í¬ ì™„ë£Œ: $(date) ==="

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::NCP ë°°í¬ ì‹¤íŒ¨! ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
          # ìŠ¬ë™ ì•Œë¦¼ (ì„ íƒ)
          # curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
          #   -H 'Content-type: application/json' \
          #   -d '{"text":"ğŸš¨ ì±—ë´‡ ë°°í¬ ì‹¤íŒ¨! í™•ì¸ í•„ìš”."}'
