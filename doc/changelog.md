# 개발 진행 내역 (Changelog)

> 마지막 업데이트: 2026-02-06

---

## Phase 13: 맥락 인식 명확화 시스템 (2026-02-06)

### 문제 상황

```
입력: "개 대려갈게"
현재: "[조선 팰리스] 어떤 시설의 위치를 알고 싶으신가요?"
     + [호텔 위치, 수영장, 피트니스...]  ← 맥락 무시!

기대: "[조선 팰리스] 반려동물을 데리고 어디를 이용하실 예정인가요?"
     + [객실 투숙, 레스토랑/다이닝, 로비/공용시설...]  ← 맥락 인식!
```

### 해결 방안

#### 1. CONTEXT_CLARIFICATION 패턴 추가 (graph.py:465-480)

```python
CONTEXT_CLARIFICATION = {
    "반려동물": {
        "keywords": ["개", "강아지", "반려견", "펫", ...],
        "direct_triggers": ["가능", "돼", "?", ...],  # 있으면 직접 검색
        "question": "반려동물을 데리고 어디를 이용하실 예정인가요?",
        "options": ["객실 투숙", "레스토랑/다이닝", ...],
    },
    "어린이": {...},
}
```

#### 2. clarificationCheckNode 수정

- 맥락 인식 패턴을 **최우선** 체크
- `direct_triggers` 있으면 → 바로 검색 (질문형)
- 없으면 → 맥락 맞춤 명확화 질문

### 테스트 결과

| 질문 | Before | After |
|------|--------|-------|
| "개 대려갈게" | 위치 옵션 ❌ | 반려동물 맥락 옵션 ✅ |
| "강아지 데려가도 돼?" | - | 직접 정책 검색 ✅ |
| "펫 동반" | 위치 옵션 ❌ | 반려동물 맥락 옵션 ✅ |

- 정확도: **96.0%** (48/50)
- 반려동물 카테고리: **100%** ✅

---

## Phase 12: 모호한 질문 의도 파악 개선 (2026-02-06)

### 문제 상황

```
입력: "강아지 대려갈게"
기대: 반려동물 정책 안내
실제: "어떤 시설의 위치를 알고 싶으신가요?" + [위치 옵션]
```

**근본 원인:**
- `specificTargets`에 반려동물 관련 키워드 누락
- `AMBIGUOUS_PATTERNS` 위치 패턴이 반려동물 맥락에서도 적용

### 해결 방안

#### 1. specificTargets 확장 (graph.py:668-690)
```python
specificTargets = [
    # ... 기존 ...
    # 반려동물 (Phase 12 추가)
    "강아지", "반려견", "반려동물", "펫", "pet", "dog", "애견",
    "고양이", "고냥이", "cat", "애완",
    "데려", "대려", "동반",  # 동사 패턴
]
```

#### 2. AMBIGUOUS_PATTERNS excludes 추가 (graph.py:452-460)
```python
"위치": {
    "excludes": [
        ...,
        "강아지", "반려", "펫", "pet", "애견", "고양이", "동반", "데려", "대려",
    ],
}
```

### 테스트 케이스 추가

| ID | 질문 | 기대 결과 |
|----|------|----------|
| pet_busan_ambiguous_001 | 강아지 대려갈게 | 반려동물 정책 안내 ✅ |
| pet_palace_ambiguous_001 | 펫 데려가도 돼? | 반려동물 정책 안내 |

### 테스트 결과

- 정확도: **94.0%** (47/50)
- "강아지 대려갈게" → 반려동물 정책 정상 안내 ✅

---

## Phase 11: 반려동물 정책 할루시네이션 수정 (2026-02-06)

### 문제 상황

```
[버그]
"강아지 데려갈 수 있나요?" 질문에 대해
챗봇: "반려동물 동반이 가능하지만..."
실제 정책: "반려동물 동반이 불가합니다"

→ 잘못된 정보 전달 (법적 리스크)
```

**근본 원인:**
- 보충 데이터(pet_policy.json)에 모호한 표현 ("호텔에 문의하세요")
- 실제 정책 데이터와 충돌 ("입장이 불가합니다")
- LLM이 두 출처를 잘못 결합

### 해결 방안

보충 데이터를 실제 호텔 정책과 정확히 일치하도록 수정:

| 호텔 | 이전 | 수정 후 |
|------|------|---------|
| 그랜드 조선 부산 | "호텔에 문의하세요" | "반려동물 동반이 불가합니다" |
| 그랜드 조선 제주 | "호텔에 문의하세요" | "반려동물 동반이 불가합니다" |
| 그래비티 판교 | "호텔에 문의하세요" | "반려동물 동반이 불가합니다" |
| 조선 팰리스 | (신규) | "반려동물 입실 가능 객실 있음" |
| 레스케이프 | (유지) | "반려견 동반 투숙 가능 (조건부)" |

### 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `data/supplementary/pet_policy.json` | 6개 호텔 반려동물 정책 정확히 기술 |

### 테스트 결과

- 정확도: 97.9% (47/48)
- 반려동물 카테고리: **100%** 통과
- 할루시네이션율: 0.0%

---

## Phase 10: 소스 URL 미스매칭 버그 수정 (2026-02-06)

### 문제 상황

```
[버그]
LLM이 4번째 청크(policy/hotel.do)의 "추가 요금 없이" 정보로 답변
하지만 참고 URL은 1번째 청크(about/faq.do)를 표시
→ 사용자가 URL 클릭해도 해당 정보 없음
```

**근본 원인:**
- 컨텍스트: 상위 5개 청크 사용
- sources: 상위 3개 청크에서만 URL 수집
- 표시: `sources[0]` (첫 번째 URL)만 표시
- LLM이 어떤 청크를 사용했는지 추적 안 함

### 해결 방안

#### 1. 컨텍스트에 청크 번호/URL 포함 (graph.py:917-935)
```
[참조1] [그래비티 판교] (출처: https://grp.josunhotel.com/about/faq.do)
Q: 객실 정원이 몇 명인가요?
...
```

#### 2. LLM 프롬프트에 참조 번호 명시 요청
- 답변 끝에 `[REF:1,3]` 형식으로 사용한 청크 번호 명시

#### 3. 응답 파싱 및 사용된 URL만 추출 (graph.py:937-967)
- `[REF:...]` 파싱하여 실제 사용된 청크의 URL만 필터링
- 사용자에게는 `[REF:...]` 부분 제거

#### 4. 모든 사용된 URL 표시 (graph.py:1595-1603)
- 단일 URL: `참고 정보: URL`
- 복수 URL: 리스트 형태로 표시

### 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `rag/graph.py` | 컨텍스트 구성, LLM 프롬프트, 참조 파싱, 소스 표시 로직 수정 |
| `data/supplementary/pet_policy.json` | 잘못된 URL 수정 |

---

## Phase 9: UI 디자인 개선 (2026-02-06)

### 변경 사항

#### 1. 색상 시스템 도입
- CSS 변수 기반 (`--color-primary`, `--color-accent`)
- 딥블루(#1a365d) + 골드 악센트(#c9a961)
- 프리미엄 호텔 브랜드에 어울리는 디자인

#### 2. 다크모드 지원
- 헤더 우측 토글 버튼 (☀️/🌙)
- Tailwind `dark:` 클래스 활용
- localStorage에 테마 저장
- 다크모드: 배경 #0f172a, 골드 악센트 유지

#### 3. 애니메이션 개선
- 메시지 진입: fadeIn + slideUp (300ms)
- 드롭다운: slideDown 애니메이션
- 버튼 호버: scale + shadow 효과
- 입력창 포커스: ring + 골드 border

#### 4. 모바일 반응형 강화
- 헤더: 모바일 텍스트 크기 조정
- 메시지: `max-w-[90%] sm:max-w-[85%]`
- 터치 타겟: 최소 44px 확보
- 모바일 전용 아이콘 버튼

### 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `ui/index.html` | 전체 리팩토링 (다크모드, 애니메이션, 반응형) |
| `ui/css/style.css` | CSS 변수, 다크모드 규칙, 신규 애니메이션 |

---

## Phase 8: 컨텍스트 오염 방지 시스템 (2026-02-05)

### 문제 상황

```
[대화 맥락]
User: "조식 시간 알려줘"
Bot: "조식은 07:00~10:30에 운영됩니다."

User: "조금 늦어도 이용 할 수 있어? 한 10분 정도"
Bot: "10:30 이후에는 19세 성인만 입장이 가능합니다..." ← 수영장 정책이 섞임!
```

**근본 원인:**
- `retrieveNode`에서 모든 카테고리 검색 (필터 없음)
- 대화 주제 추적 안 함 → 수영장 정책이 조식 답변에 혼입
- Grounding Gate가 카테고리 교차 오염 미감지

### 해결 방안

#### 1. 대화 주제 추적
- `RAGState`에 `conversation_topic`, `effective_category` 필드 추가
- `_extractConversationTopic()` 함수: 최근 4개 메시지에서 주제 추출

#### 2. 카테고리 기반 검색 필터링
- 후속 질문(히스토리 있음)에서만 카테고리 필터 적용
- 결과 < 2개 시 폴백 (필터 제거 재검색)

#### 3. 카테고리 교차 오염 감지
- `CategoryConsistencyChecker` 클래스 추가
- `EXCLUSIVE_KEYWORDS`: 카테고리별 own/foreign 키워드 정의
- 오염된 문장 자동 제거

#### 4. 답변 검증 강화
- `answerVerifyNode`에 Phase 3.5 추가 (카테고리 오염 검사)

### 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `rag/graph.py` | RAGState 확장, 주제 추출 함수, retrieveNode 수정, 오염 검사 적용 |
| `rag/grounding.py` | `CategoryConsistencyChecker` 클래스, `verifyCategoryConsistency()` 함수 |
| `tests/test_grounding.py` | 카테고리 오염 감지/정제 테스트 추가 |

### 테스트 결과

- 기존 평가 테스트: **48/48 (100%)** 유지
- Grounding 테스트: **8/8 (100%)** 통과
- 대화 맥락 오염 방지: 정상 동작 확인

---

## Phase 7: 쿼리 검증 강화 (2026-02-04)

### 변경 사항
- `VALID_QUERY_KEYWORDS` 586개로 확장
- 무관한 질문 차단 ("복실이 이쁘니?" 등)
- `EVIDENCE_THRESHOLD`: 0.65

### 결과
- 정확도: **100%** (48/48)

---

## Phase 6: 프롬프트 개선 (2026-02-04)

### 변경 사항
- 불필요한 후속 질문 제거 ("궁금하신가요?" 등 금지)
- Temperature 0.1로 낮춤 (일관된 응답)
- 절대 금지 규칙 명시

---

## Phase 5: 모니터링 시스템 (2026-02-04)

### 추가 파일
- `monitor/dashboard.py`: CLI 대시보드
- `monitor/analyzer.py`: 로그 분석기
- `monitor/collector.py`: 실패 케이스 수집기

---

## Phase 4: 데이터 품질 개선 (2026-02-04)

### 변경 사항
- 주차/위치 정보 보충 (7개 청크 추가)
- 총 361개 청크 인덱싱
- `pipeline/index_supplementary.py` 추가

### 결과
- 정확도: **100%** (48/48)

---

## Phase 3: 답변 검증 노드 (2026-02-04)

### 변경 사항
- 숫자 정보 할루시네이션 감지
- 추측 표현 필터링 ("약", "대략", "아마")
- Grounding Gate 기반 문장 단위 검증

---

## Phase 2: BM25 하이브리드 검색 (2026-02-04)

### 변경 사항
- Vector (70%) + BM25 (30%) 결합
- 한국어 토크나이저 적용
- `pipeline/indexer.py` 수정

---

## Phase 1: 자동 평가 시스템 (2026-02-04)

### 추가 파일
- `tests/evaluate.py`: 자동 평가 스크립트
- `tests/golden_qa.json`: 48개 테스트 케이스

### 초기 정확도
- 91.7% (44/48)

---

## 초기 구축 (2026-02-03 이전)

### 핵심 구성
- 호텔 FAQ 크롤러 (`crawler/`)
- 데이터 정제/청킹 파이프라인 (`pipeline/`)
- LangGraph 기반 RAG 서버 (`rag/`)
- Chroma Vector DB + BM25 하이브리드 검색

### 정책 원칙
- **No Retrieval, No Answer**: 근거 없는 답변 금지
- 출처 URL 필수 포함
- 개인정보 요구 금지
